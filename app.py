import streamlit as st
import pandas as pd
import numpy as np
from sentence_transformers import SentenceTransformer, util
import torch

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ ---
st.set_page_config(
    page_title="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ü–æ–∏—Å–∫",
    page_icon="üîç",
    layout="wide"
)

# --- –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò (–ö–≠–®–ò–†–û–í–ê–ù–ò–ï) ---
# –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –º—É–ª—å—Ç–∏–∑—ã—á–Ω—É—é –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è —Ö–æ—Ä–æ—à–æ –ø–æ–Ω–∏–º–∞–µ—Ç –∏ —Ä—É—Å—Å–∫–∏–π, –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π.
# @st.cache_resource –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –∞ –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ.
@st.cache_resource
def load_model():
    # 'paraphrase-multilingual-MiniLM-L12-v2' ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
    return SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')

try:
    with st.spinner('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)...'):
        model = load_model()
except Exception as e:
    st.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: {e}")
    st.stop()

# --- –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–î–ê–¢–ê–°–ï–¢) ---
# –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —ç—Ç–æ –∑–∞–≥—Ä—É–∂–∞–ª–æ—Å—å –±—ã –∏–∑ CSV –∏–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
if 'documents' not in st.session_state:
    st.session_state.documents = [
        {
            "id": 1,
            "title": "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ—Ç–ø—É—Å–∫–∞",
            "content": "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –µ–∂–µ–≥–æ–¥–Ω–æ–≥–æ –æ–ø–ª–∞—á–∏–≤–∞–µ–º–æ–≥–æ –æ—Ç–ø—É—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–µ –≤ HR-–æ—Ç–¥–µ–ª –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 2 –Ω–µ–¥–µ–ª–∏ –¥–æ –Ω–∞—á–∞–ª–∞. –ó–∞—è–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º.",
            "category": "HR"
        },
        {
            "id": 2,
            "title": "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPN",
            "content": "–î–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç OpenVPN. –°–µ—Ä–≤–µ—Ä: vpn.company.com. –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –¥–æ–º–µ–Ω–Ω—ã–º –ª–æ–≥–∏–Ω–æ–º –∏ –ø–∞—Ä–æ–ª–µ–º.",
            "category": "IT"
        },
        {
            "id": 3,
            "title": "–ü–æ–ª–∏—Ç–∏–∫–∞ –î—Ä–µ—Å—Å-–∫–æ–¥–∞",
            "content": "–í –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–∏–Ω—è—Ç —Å—Ç–∏–ª—å Business Casual. –ü–æ –ø—è—Ç–Ω–∏—Ü–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω —Å–≤–æ–±–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å –æ–¥–µ–∂–¥—ã. –ó–∞–ø—Ä–µ—â–µ–Ω—ã —à–æ—Ä—Ç—ã –∏ –æ—Ç–∫—Ä—ã—Ç–∞—è –æ–±—É–≤—å –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.",
            "category": "HR"
        },
        {
            "id": 4,
            "title": "–ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã",
            "content": "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–¥–∞–Ω—ã –¥–æ 5 —á–∏—Å–ª–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞. –§–æ—Ä–º–∞ –æ—Ç—á–µ—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º –ø–æ—Ä—Ç–∞–ª–µ –≤ —Ä–∞–∑–¥–µ–ª–µ –§–∏–Ω–∞–Ω—Å—ã.",
            "category": "–§–∏–Ω–∞–Ω—Å—ã"
        },
        {
            "id": 5,
            "title": "–ó–∞–∫–∞–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∏",
            "content": "–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É –∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –æ—Ñ–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –ø–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞–º. –í—ã–¥–∞—á–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø–æ —á–µ—Ç–≤–µ—Ä–≥–∞–º –Ω–∞ —Å—Ç–æ–π–∫–µ —Ä–µ—Å–µ–ø—à–Ω.",
            "category": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è"
        },
        {
            "id": 6,
            "title": "–ë–æ–ª—å–Ω–∏—á–Ω—ã–π –ª–∏—Å—Ç",
            "content": "–ü—Ä–∏ –±–æ–ª–µ–∑–Ω–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–∫—Ä—ã—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –±–æ–ª—å–Ω–∏—á–Ω—ã–π –ª–∏—Å—Ç –∏ —Å–æ–æ–±—â–∏—Ç—å –Ω–æ–º–µ—Ä —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é. –í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–∏–π –¥–µ–Ω—å –∑–∞—Ä–ø–ª–∞—Ç—ã.",
            "category": "HR"
        }
    ]

# --- –§–£–ù–ö–¶–ò–Ø –ü–û–ò–°–ö–ê ---
def search(query, docs, top_k=3):
    """
    1. –í–µ–∫—Ç–æ—Ä–∏–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å.
    2. –í–µ–∫—Ç–æ—Ä–∏–∑—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–æ–∫–∏ –≤–µ–∫—Ç–æ—Ä–∏–∑—É—é—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ).
    3. –°—á–∏—Ç–∞–µ—Ç –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ.
    """
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç—ã –∏–∑ —Å–ª–æ–≤–∞—Ä–µ–π
    corpus = [doc['content'] for doc in docs]
    
    # –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Encoding)
    query_embedding = model.encode(query, convert_to_tensor=True)
    corpus_embeddings = model.encode(corpus, convert_to_tensor=True)
    
    # –ü–æ–∏—Å–∫ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏ (Cosine Similarity)
    # –†–µ–∑—É–ª—å—Ç–∞—Ç - —Å–ø–∏—Å–æ–∫ –æ—Ü–µ–Ω–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –æ—Ç 0 –¥–æ 1
    cos_scores = util.cos_sim(query_embedding, corpus_embeddings)[0]
    
    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (top_k –ª—É—á—à–∏—Ö)
    top_results = torch.topk(cos_scores, k=min(top_k, len(corpus)))
    
    results = []
    for score, idx in zip(top_results[0], top_results[1]):
        doc_idx = int(idx)
        results.append({
            "score": float(score),
            "doc": docs[doc_idx]
        })
    return results

# --- –ò–ù–¢–ï–†–§–ï–ô–° (FRONTEND) ---

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
with st.sidebar:
    st.header("‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π")
    st.info("–≠—Ç–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∏—Å—Ç–µ–º—ã —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º.")
    
    with st.expander("‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç"):
        new_title = st.text_input("–ó–∞–≥–æ–ª–æ–≤–æ–∫")
        new_cat = st.selectbox("–ö–∞—Ç–µ–≥–æ—Ä–∏—è", ["HR", "IT", "–§–∏–Ω–∞–Ω—Å—ã", "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è", "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞"])
        new_content = st.text_area("–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞")
        
        if st.button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É"):
            if new_title and new_content:
                new_id = len(st.session_state.documents) + 1
                st.session_state.documents.append({
                    "id": new_id,
                    "title": new_title,
                    "content": new_content,
                    "category": new_cat
                })
                st.success("–î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω! –¢–µ–ø–µ—Ä—å –µ–≥–æ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏.")
            else:
                st.warning("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.")
    
    st.markdown("---")
    st.write(f"–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ: **{len(st.session_state.documents)}**")

# –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å
st.title("üß† –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π AI –ü–æ–∏—Å–∫")
st.markdown("""
–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, –∞ –ø–æ **—Å–º—ã—Å–ª—É**. 
–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã, —Å–ª–æ–≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ –Ω–∞–ø—Ä—è–º—É—é.
""")

# –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞
query = st.text_input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å:", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–∞–∫ —É–π—Ç–∏ –æ—Ç–¥—ã—Ö–∞—Ç—å –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º")

if query:
    st.subheader("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:")
    
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
    with st.spinner('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–º—ã—Å–ª–æ–≤—ã–µ —Å–≤—è–∑–∏...'):
        results = search(query, st.session_state.documents)
    
    # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    if not results:
        st.warning("–ù–∏—á–µ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
    
    for hit in results:
        score = hit['score']
        doc = hit['doc']
        
        # –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        # –¶–≤–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
        border_color = "green" if score > 0.5 else "orange"
        
        with st.container():
            col1, col2 = st.columns([1, 5])
            
            with col1:
                st.metric(label="–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å", value=f"{score:.2%}")
            
            with col2:
                st.markdown(f"### {doc['title']} <span style='font-size:0.8em; color:gray; background:#f0f0f0; padding:2px 8px; border-radius:10px;'>{doc['category']}</span>", unsafe_allow_html=True)
                st.write(doc['content'])
            
            st.markdown("---")

# –û—Ç–ª–∞–¥–∫–∞: –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –±–∞–∑—É
with st.expander("üìÇ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ"):
    df = pd.DataFrame(st.session_state.documents)
    st.dataframe(df, use_container_width=True)

# Footer
st.markdown("""
<div style='text-align: center; color: gray; margin-top: 50px;'>
    –ü—Ä–æ–µ–∫—Ç –ø–æ Machine Learning | Powered by Sentence-Transformers & Streamlit
</div>
""", unsafe_allow_html=True)